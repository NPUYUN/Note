# 网络流
## 基础概念
网络流问题是**图论中的一类优化问题**，核心是研究“资源在有向网络中如何传输”，目标是找到满足约束条件的最优传输方案（如最大传输量、最小传输成本等）。它本质是将现实中的“流量传输”场景（如物流、通信、水电管网）抽象为数学模型，通过算法求解最优解。

### 一、网络流的核心模型：有向容量网络
所有网络流问题都基于一个基础结构——**有向容量网络**，可表示为一个有向图 \( G = (V, E) \)，其中包含以下关键组件：

| 组件          | 定义与作用                                                                 | 类比（水管网络）               |
|---------------|----------------------------------------------------------------------------|--------------------------------|
| **顶点集 \( V \)** | 代表网络中的“节点”（如物流中的仓库、配送站，通信中的路由器）。              | 水管的连接点、阀门             |
| **有向边集 \( E \)** | 代表节点间的“传输通道”（方向表示资源流动方向）。每条边 \( e = (u, v) \) 表示从顶点 \( u \) 到 \( v \) 的通道。 | 单向水管（只能从A流向B）       |
| **容量 \( c(e) \)** | 每条边的“最大传输上限”（非负整数或实数），表示该通道最多能承载的资源量。   | 水管的最大通水能力（如10L/分钟）|
| **源点 \( s \)**   | 唯一的“资源起点”（只有流出边，无流入边），是资源的唯一产生地。             | 水厂（唯一的水源）             |
| **汇点 \( t \)**   | 唯一的“资源终点”（只有流入边，无流出边），是资源的唯一消耗地。             | 用户的水龙头（唯一的用水点）   |
| **流量 \( f(e) \)** | 每条边的“实际传输量”（需满足 \( 0 \leq f(e) \leq c(e) \)），是待求解的变量。 | 水管中实际的水流速度（如5L/分钟）|


### 二、网络流的2个核心约束（流量守恒）
为了保证模型的合理性，流量 \( f \) 必须满足两个基本约束，这是所有网络流问题的前提：

1. **容量约束**：对任意边 \( e = (u, v) \)，实际流量不能超过边的容量，即  
   \( 0 \leq f(u, v) \leq c(u, v) \)  
   （类比：水管中的实际水流不能超过水管的最大通水能力，否则会“爆管”）。

2. **流量守恒定律**：对任意**非源点、非汇点**的中间顶点 \( u \)，流入该顶点的总流量 = 流出该顶点的总流量，即  
   \( \sum_{v \in V} f(v, u) = \sum_{v \in V} f(u, v) \)  
   （类比：中间节点的水管不会“储存”资源，流入的水必须全部流出，没有损耗或囤积）。


### 三、常见的网络流问题类型
网络流问题根据“优化目标”可分为多个子类，其中最经典、应用最广的是以下3类：

#### 1. 最大流问题（Max Flow Problem）
- **问题目标**：找到从源点 \( s \) 到汇点 \( t \) 的**最大可能总流量**（即整个网络的最大传输能力）。
- **核心定理**：**最大流最小割定理**（Max-Flow Min-Cut Theorem）——网络的最大流值 = 分割源点和汇点的“最小割容量”（“割”是将顶点分为 \( S \)（含 \( s \)）和 \( T \)（含 \( t \)）的集合，割容量是所有从 \( S \) 到 \( T \) 的边的容量之和）。
- **应用场景**：
  - 物流：从仓库（\( s \)）到门店（\( t \)）的最大货物运输量。
  - 通信：从基站（\( s \)）到用户终端（\( t \)）的最大数据传输速率。


#### 2. 最小割问题（Min Cut Problem）
- **问题目标**：找到分割源点 \( s \) 和汇点 \( t \) 的**最小容量割集**（即“切断”哪些通道能以最小代价阻断 \( s \) 到 \( t \) 的所有流量）。
- **与最大流的关系**：由最大流最小割定理可知，最小割的容量等于最大流的流量，因此可通过求解最大流间接得到最小割。
- **应用场景**：
  - 网络安全：切断黑客服务器（\( s \)）到目标主机（\( t \)）的最小关键链路集。
  - 电力系统：故障时，切断最小容量的线路以隔离故障区域，减少损失。


#### 3. 最小费用最大流问题（Min-Cost Max-Flow Problem）
- **问题目标**：在保证“最大流”的前提下，找到**总传输成本最低**的流量分配方案（每条边额外增加“单位流量成本” \( w(e) \)，总费用为 \( \sum f(e) \times w(e) \)）。
- **核心逻辑**：先满足“最大流量”约束，再优化“成本”；或在流量递增过程中，优先选择成本最低的传输路径。
- **应用场景**：
  - 快递配送：从分拣中心（\( s \)）到网点（\( t \)），在运输最大包裹量的同时，最小化运输成本（如油费、过路费）。
  - 供应链：从工厂（\( s \)）到经销商（\( t \)），最大供货量下的最小仓储+运输费用。


### 四、经典求解算法
网络流的算法围绕“如何高效找到可行流并优化目标”展开，不同问题对应不同算法，以下是核心算法的分类：

| 问题类型       | 经典算法                          | 核心思想                                                                 |
|----------------|-----------------------------------|--------------------------------------------------------------------------|
| 最大流         | Ford-Fulkerson 方法（含 Edmonds-Karp 算法） | 反复寻找“增广路”（从 \( s \) 到 \( t \) 且仍有剩余容量的路径），直到无增广路。 |
| 最大流（高效版）| Dinic 算法、ISAP 算法             | 通过“分层图”（按距离 \( s \) 的层数划分顶点）快速定位增广路，适合大规模网络。 |
| 最小费用最大流 |  successive shortest augmenting path（ successive 最短路增广） | 在最大流框架下，每次选择“单位成本最低”的增广路，逐步增加流量。            |
| 最小费用最大流 | 容量缩放算法、消圈算法            | 前者通过缩放容量加速寻找增广路，后者通过消除“负成本回路”优化现有流量。    |


## Python求解网络流问题
### 最小费用最大流问题
最小费用最大流问题是指在一个网络中，从源点到汇点的最大流量问题，同时考虑每条边的成本。
NetworkX 是一个功能强大的 Python 库，用于创建、操作和研究复杂网络结构。它提供了丰富的功能。
其中求解最小费用最大流的核心函数有：
- `max_flow_min_cost (flowG, _s, _t, capacity='capacity', cost='cost', flow_func=None, *kwargs)` 求解最小费用最大流问题
- `max_flow_min_cost_value (flowG, _s, _t, capacity='capacity', cost='cost', flow_func=None, *kwargs)` 最大流问题的流量值

其中，
- `flowG` 是一个 NetworkX 图对象，包含了网络的结构和边的属性（如容量 `capacity` 和成本 `cost`）。
- `_s` 和 `_t` 分别是源点和汇点的标识符，用于指定最大流问题的起点和终点。
- `capacity` 和 `cost` 是边属性的名称，默认值分别为 `'capacity'` 和 `'cost'`，用于指定边的容量和成本。
- `flow_func` 是一个可选参数，用于指定使用的流量函数（如 `'EdmondsKarp'` 或 `'Dinic'`），默认值为 `None`，表示使用 NetworkX 默认的流量函数。
- `*kwargs` 是其他可选参数，用于传递给流量函数的额外参数（如 `'raise_error'` 用于指定是否在流量超过容量时抛出异常）。

#### 基础流程如下
``` python
import networkx as nx
import matplotlib.pyplot as plt

# 创建有向图
G = nx.DiGraph()

# 添加边，并设置容量（capacity）和单位流量的成本（weight）
# 格式：起点，终点，容量，成本
edges = [
    ('s', 'v1', 8, 2),
    ('s', 'v3', 7, 8),
    ('v1', 'v3', 5, 5),
    ('v1', 'v2', 9, 2),
    ('v3', 'v4', 9, 3),
    ('v2', 'v3', 2, 1),
    ('v4', 't', 10, 7),
    ('v2', 't', 5, 6),
    ('v4', 'v2', 6, 4)
]

for u, v, cap, cost in edges:
    G.add_edge(u, v, capacity=cap, weight=cost)  # 注意：成本属性键为 'weight'

# 计算从源点 's' 到汇点 't' 的最小费用最大流
flow_dict = nx.max_flow_min_cost(G, 's', 't')

# 计算总费用
min_cost = nx.cost_of_flow(G, flow_dict)

# 计算总流量（最大流）
max_flow_value = sum(flow_dict['s'].values())

print(f"最大流量: {max_flow_value}")
print(f"最小费用: {min_cost}")
print("\n各边流量分配详情:")
for u, neighbors in flow_dict.items():
    for v, flow in neighbors.items():
        if flow > 0:  # 只显示有流量的边
            print(f"  {u} -> {v}: 流量 = {flow}")
```
代码解释：
- 创建有向图 `G`，并添加边。
- 调用 `nx.max_flow_min_cost(G, 's', 't')` 计算最小费用最大流。
- 使用 `nx.cost_of_flow(G, flow_dict)` 计算总费用。
- 计算最大流值为 `sum(flow_dict['s'].values())`。
- 输出各边流量分配详情，只显示有流量的边。

## 一个典型的最小费用最大流问题

最大流、最小割问题见**网络与图模型**